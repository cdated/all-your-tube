<link rel="stylesheet" href="{{ url_for('bp.static', filename='css/log.css') }}">

<h1>Download Logs</h1>

<div class="log-controls">
    <button id="toggleAutoScroll" class="active">Auto-Scroll: ON</button>
    <button id="scrollToTop">Scroll to Top</button>
    <button id="scrollToBottom">Scroll to Bottom</button>
    <span id="connectionStatus" class="status-indicator status-connected">● Connected</span>
</div>

<pre id="desc"></pre>

<div id="logs">
    <pre id="output"></pre>
    <div id="newContentIndicator" class="new-content-indicator">New content available ↓</div>
</div>

<script>
    var output = document.getElementById('output');
    var desc = document.getElementById('desc');
    var logs = document.getElementById('logs');
    var toggleBtn = document.getElementById('toggleAutoScroll');
    var scrollTopBtn = document.getElementById('scrollToTop');
    var scrollBtn = document.getElementById('scrollToBottom');
    var statusIndicator = document.getElementById('connectionStatus');
    var newContentIndicator = document.getElementById('newContentIndicator');

    var autoScroll = true;
    var isUserScrolling = false;
    var hasNewContent = false;

    // Scroll detection
    logs.addEventListener('scroll', function () {
        isUserScrolling = true;
        var isAtBottom = (logs.scrollTop + logs.offsetHeight) >= (logs.scrollHeight - 50);

        if (isAtBottom) {
            hasNewContent = false;
            newContentIndicator.style.display = 'none';
        }

        setTimeout(function () {
            isUserScrolling = false;
        }, 1000);
    });

    function scrollToTop() {
        logs.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
        hasNewContent = false;
        newContentIndicator.style.display = 'none';
    }

    // Smooth scroll to bottom
    function scrollToBottom() {
        logs.scrollTo({
            top: logs.scrollHeight,
            behavior: 'smooth'
        });
        hasNewContent = false;
        newContentIndicator.style.display = 'none';
    }

    // Toggle auto-scroll
    toggleBtn.addEventListener('click', function () {
        autoScroll = !autoScroll;
        toggleBtn.textContent = autoScroll ? 'Auto-Scroll: ON' : 'Auto-Scroll: OFF';
        toggleBtn.className = autoScroll ? 'active' : '';

        if (autoScroll && hasNewContent) {
            scrollToBottom();
        }
    });

    // Scroll to top button
    scrollTopBtn.addEventListener('click', scrollToTop);

    // Scroll to bottom button
    scrollBtn.addEventListener('click', scrollToBottom);

    // New content indicator click
    newContentIndicator.addEventListener('click', scrollToBottom);

    // Get the description of the download event
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '{{ url_for('bp.log_desc', pid=pid, subdir=subdir) }}');
    xhr.send();

    // Get the logs data from the server
    var source = new EventSource("{{ url_for('bp.stream', pid=pid, subdir=subdir) }}");

    source.onopen = function () {
        statusIndicator.textContent = '● Connected';
        statusIndicator.className = 'status-indicator status-connected';
    };

    source.onerror = function () {
        statusIndicator.textContent = '● Disconnected';
        statusIndicator.className = 'status-indicator status-disconnected';
    };

    source.onmessage = function (event) {
        // Check if user is at bottom before adding content
        var wasAtBottom = (logs.scrollTop + logs.offsetHeight) >= (logs.scrollHeight - 10);

        output.textContent += "\n" + event.data;

        // Auto-scroll if enabled, user isn't scrolling
        if (autoScroll && !isUserScrolling) {
            logs.scrollTop = logs.scrollHeight;
        } else if (!wasAtBottom) {
            // Show new content indicator if user has scrolled up
            hasNewContent = true;
            newContentIndicator.style.display = 'block';
        }

        if (!event.data.includes("[download] Sleeping")) {
            desc.textContent = "Status: " + event.data;
        }

        if (event.data == "Download Complete") {
            source.close();
            statusIndicator.textContent = '● Complete';
            statusIndicator.className = 'status-indicator status-connected';
        }
    };
</script>
